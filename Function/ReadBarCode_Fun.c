/***************************************************************************************************
*FileName: ReadBarCode_Fun.c
*Description:
*Author: xsx_kair
*Data:
***************************************************************************************************/

/***************************************************************************************************/
/******************************************Header List********************************************/
/***************************************************************************************************/
#include	"ReadBarCode_Fun.h"

#include	"Usart1_Driver.h"

#include	"QueueUnits.h"

#include	"System_Data.h"

#include	<string.h>
#include	"stdio.h"
/***************************************************************************************************/
/***************************************************************************************************/
/***************************************************************************************************/
static xSemaphoreHandle xBarCodeSemaphore;													//读取到条码，通知
static char S_BarCode[100];
/***************************************************************************************************/
/***************************************************************************************************/
/***************************************************************************************************/
static void SendBarCodeSemaphore(void);
/***************************************************************************************************/
/***************************************************************************************************/
/***************************************************************************************************/
/****************************************File Start*************************************************/
/***************************************************************************************************/
/***************************************************************************************************/

void ReadBarCodeFunction(void)
{
	
	memset(S_BarCode, 0, 100);
	
	ReceiveDataFromQueue(GetUsart1RXQueue(), GetUsart1RXMutex(), S_BarCode, 100, 1, 10 / portTICK_RATE_MS);	
	
	if(strlen(S_BarCode) > 1)
	{
		if(S_BarCode[strlen(S_BarCode)-1] == 0x0d)
			S_BarCode[strlen(S_BarCode)-1] = 0;
		
		SetGB_BarCode(S_BarCode);
		
		memset(S_BarCode, 0, 100);
		
		SendBarCodeSemaphore();
	}
}

MyState_TypeDef CheckBarCodeHasRead(void)
{
	if(NULL == xBarCodeSemaphore)
		vSemaphoreCreateBinary(xBarCodeSemaphore);
	
	if(pdPASS == xSemaphoreTake(xBarCodeSemaphore, 10 / portTICK_RATE_MS))
		return My_Pass;
	else
		return My_Fail;
}

static void SendBarCodeSemaphore(void)
{
	if(NULL == xBarCodeSemaphore)
		vSemaphoreCreateBinary(xBarCodeSemaphore);
	
	xSemaphoreGive(xBarCodeSemaphore);
}

/****************************************end of file************************************************/
